<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><base href=https://www.lowrisc.org><link rel=icon type=image/png sizes=32x32 href=/favicon.png><title>Bootload procedure &middot; lowRISC: Collaborative open silicon engineering</title><link href=/main.f5831.css rel=stylesheet></head><body><header><nav class="navbar navbar-expand-md navbar-light"><div class=container><a class=navbar-brand href=#><img src=/img/logo/logo-dualcolor.svg alt=lowRISC></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav ml-auto"><li class=nav-item><a href=/our-work class=nav-link>Our work</a></li><li class=nav-item><a href=/open-silicon class=nav-link>Open Silicon</a></li><li class=nav-item><a href=/community class=nav-link>Community</a></li><li class=nav-item><a href=/blog class=nav-link>Blog</a></li><li class=nav-item><a href=/jobs class=nav-link>Jobs</a></li><li class=nav-item><a href=/about class=nav-link>About us</a></li><li class=nav-item><a class="btn lr-navbar-btn-gh" href=https://github.com/lowrisc>GitHub</a></li></ul></div></div></nav></header><main role=main><div class=container><h1>Bootload procedure</h1><p><strong>Note: the content of this section is subject to change as the specification develops.</strong></p><p>This document explains the procedure required to boot the RISC-V Linux port.</p><h4 id=system-status-after-power-on:8aff651d0d140074a960c33ac3b02ecb>System status after power-on</h4><p>After a hard (power off/on) reset, the whole SoC, including all PCRs are reset
to their initial values:</p><ul><li><strong>Pipeline</strong>: Flushed.</li><li><strong>L1 I$</strong>: Invalidated, PC &lt;= <code>0x00000000_00000200</code>.</li><li><strong>L1 D$</strong>: Invalidated.</li><li><strong>L2</strong>: Invalidated.</li><li><strong>PCRs</strong>: reset and interrupt disabled.</li></ul><table><thead><tr><th></th><th>actual address spaces</th><th>mapped address spaces</th><th>Type</th></tr></thead><tbody><tr><td>Memory section 0</td><td>(<code>0x00000000 - 0x7FFFFFFF</code>)</td><td>(<code>0x00000000 - 0x7FFFFFFF</code>)</td><td>Mem</td></tr><tr><td>&gt; <em>On-chip BRAM (64 KB)</em></td><td>(<code>0x00000000 - 0x0000FFFF</code>)</td><td>(<code>0x00000000 - 0x0000FFFF</code>)</td><td>Mem</td></tr><tr><td>&gt; <em>DDR DRAM</em></td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>Mem</td></tr><tr><td>I/O section 0</td><td>(<code>0x80000000 - 0x8FFFFFFF</code>)</td><td>(<code>0x80000000 - 0x8FFFFFFF</code>)</td><td>I/O</td></tr><tr><td>&gt; <em>UART &amp; SD</em></td><td>(<code>0x80000000 - 0x8001FFFF</code>)</td><td>(<code>0x80000000 - 0x8001FFFF</code>)</td><td>I/O</td></tr></tbody></table><h4 id=copy-bbl-from-sd-to-ddr-ram:8aff651d0d140074a960c33ac3b02ecb>Copy BBL from SD to DDR RAM</h4><p>The actual bootloader for RISC-V Linux is a revised Berkeley bootloader (BBL)
located at <code>$TOP/fpga/board/$FPGA_BOARD/bbl/</code>.
The original BBL can be found at <code>$TOP/riscv-tools/riscv-pk/pk/</code>, which is still needed for running Spike simulations.</p><p>Since the size of BBL is larger than 64 KB (the size of the on-chip boot RAM),
it is stored on an SD card and copied to DDR RAM during boot. An example
program named &lsquo;boot&rsquo; (<code>$TOP/fpga/board/$FPGA_BOARD/examples/boot.c</code>) is
provided as the first stage bootloader. Please see <a href=../fpga-demo#boot>FPGA demo - Boot RISC-V
Linux</a> for more information.</p><p>Before copying the BBL to DRAM, it is necessary to map the DRAM to I/O space
in order to bypass L1/2 caches. Otherwise, some parts of BBL may remain in
caches and become lost when the first stage bootloader &lsquo;boot&rsquo; resets the SoC
to transfer control to the BBL. The mapping used for BBL copying should look
like:</p><table><thead><tr><th></th><th>actual address spaces</th><th>mapped address spaces</th><th>Type</th></tr></thead><tbody><tr><td>Memory section 0</td><td>(<code>0x00000000 - 0x3FFFFFFF</code>)</td><td>(<code>0x00000000 - 0x3FFFFFFF</code>)</td><td>Mem</td></tr><tr><td>&gt; <em>On-chip BRAM (64 KB)</em></td><td>(<code>0x00000000 - 0x0000FFFF</code>)</td><td>(<code>0x00000000 - 0x0000FFFF</code>)</td><td>Mem</td></tr><tr><td>I/O section 0</td><td>(<code>0x80000000 - 0x0FFFFFFF</code>)</td><td>(<code>0x80000000 - 0x0FFFFFFF</code>)</td><td>I/O</td></tr><tr><td>&gt; <em>UART &amp; SD</em></td><td>(<code>0x80000000 - 0x8001FFFF</code>)</td><td>(<code>0x80000000 - 0x8001FFFF</code>)</td><td>I/O</td></tr><tr><td>I/O section 1</td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>I/O</td></tr><tr><td>&gt; <em>DDR DRAM</em></td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>I/O</td></tr></tbody></table><p>The BBL is then copied from SD to DDR DRAM starting from address <code>0x40000000</code>.</p><h4 id=soft-reset:8aff651d0d140074a960c33ac3b02ecb>Soft reset</h4><p>After copying the BBL to DDR, the first-stage bootloader maps the DDR RAM to
boot memory. Consequently the on-chip BRAM is hidden.</p><table><thead><tr><th></th><th>actual address spaces</th><th>mapped address spaces</th><th>Type</th></tr></thead><tbody><tr><td>Memory section 0</td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>(<code>0x00000000 - 0x3FFFFFFF</code>)</td><td>Mem</td></tr><tr><td>&gt; <em>DDR DRAM</em></td><td>(<code>0x40000000 - 0x7FFFFFFF</code>)</td><td>(<code>0x00000000 - 0x3FFFFFFF</code>)</td><td>Mem</td></tr><tr><td>I/O section 0</td><td>(<code>0x80000000 - 0x0FFFFFFF</code>)</td><td>(<code>0x80000000 - 0x0FFFFFFF</code>)</td><td>I/O</td></tr><tr><td>&gt; <em>UART &amp; SD</em></td><td>(<code>0x80000000 - 0x8001FFFF</code>)</td><td>(<code>0x80000000 - 0x8001FFFF</code>)</td><td>I/O</td></tr><tr><td>Other</td><td></td><td></td><td></td></tr><tr><td>&gt; <em>On-chip BRAM (64 KB)</em></td><td>(<code>0x00000000 - 0x0000FFFF</code>)</td><td>Hidden</td><td>N/A</td></tr></tbody></table><p>Once the mapping is done, the first stage bootloader issues a soft reset:</p><ul><li><strong>Pipeline</strong>: Flushed.</li><li><strong>L1 I$</strong>: Invalidated, PC &lt;= <code>0x00000000_00000200</code>.</li><li><strong>L1 D$</strong>: Invalidated.</li><li><strong>L2</strong>: Invalidated.</li><li><strong>PCRs</strong>: <em>Remain unchanged</em>.</li></ul><h4 id=bbl:8aff651d0d140074a960c33ac3b02ecb>BBL</h4><p>BBL runs after the soft reset as DDR is now mapped to the boot address
<code>0x00000200</code>. The major function of the BBL is to initialize all peripherals,
set up the page table and virtual memory, load the Linux kernel from SD to
virtual memory, and finally boot the kernel.</p><p>During the kernel execution, BBL continues running underneath the kernel as a
hypervisor, serving all peripheral requests from Linux using the actual FPGA
hardware.</p></div></main><footer class=lr-footer><div class=container><div class=row><div class="col-lg-2 d-none d-lg-block"><img src=/img/logo/logo-dualcolor.svg width=150px></div><div class=col><p><small>The text content on this website is licensed under a <a href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a>, except where otherwise noted. No license is granted for logos or other trademarks. Other content &copy; lowRISC Contributors.</small></p><p><small><a href=/privacy-policy>Privacy and cookies policy</a>
&middot; <a href=/usage-licence>Usage licence</a></small></p></div><div class=col-lg-2><p><a href=#>Back to top</a></p></div></div></div></footer><script src=/main.f5831.js></script></body></html>